---
name: Test

on:
  push:
    paths:
      - 'go.*'
      - '**.go'
      - '**.h'
      - '**.c'
      - 'examples/**'
      - 'src/**'
      - 'pkg/**'
      - 'cmd/**'
      - '.github/workflows/test.yaml'
  pull_request:
    paths:
      - 'go.*'
      - '**.go'
      - '**.h'
      - '**.c'
      - 'examples/**'
      - 'src/**'
      - 'pkg/**'
      - 'cmd/**'
      - '.github/workflows/test.yaml'

jobs:
  build:
    name: Build
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: ./go.mod
          cache: true

      - name: Install build tools
        run: make install-build-tools

      - name: Build Vinbero
        run: make build

      - name: Test pass init() phase of all packages
        run: make test-runnable

      - name: Upload Vinbero binary
        uses: actions/upload-artifact@v4
        with:
          name: vinbero-binary
          path: out/bin/vinbero
          retention-days: 1

  unit-test:
    name: Unit Test
    runs-on: ubuntu-latest
    needs: build
    permissions:
      contents: read
    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: ./go.mod
          cache: true

      - name: Run unit tests
        run: go test -exec "sudo -E" -race -covermode=atomic -coverprofile=coverage.out -v ./...

  integration-test:
    name: Integration Test - ${{ matrix.example }}
    runs-on: ubuntu-latest
    needs: build
    permissions:
      contents: read
    strategy:
      fail-fast: false
      matrix:
        example:
          - end
          # Add more examples as they are created:
          # - end-dx4
          # - end-dx6
          # - transit-v4
          # - transit-v6
    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: Download Vinbero binary
        uses: actions/download-artifact@v4
        with:
          name: vinbero-binary
          path: out/bin/

      - name: Make binary executable
        run: chmod +x out/bin/vinbero

      - name: Install test dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            iproute2 \
            iputils-ping \
            curl

      - name: Setup test environment
        working-directory: examples/${{ matrix.example }}
        run: sudo ./setup.sh

      - name: Run tests
        working-directory: examples/${{ matrix.example }}
        run: sudo ./test.sh

      - name: Cleanup
        if: always()
        working-directory: examples/${{ matrix.example }}
        run: sudo ./teardown.sh || true

      - name: Show logs on failure
        if: failure()
        run: |
          echo "=== Vinbero logs ==="
          cat /tmp/vinbero_test.log 2>/dev/null || echo "No log file found"
          echo "=== Network namespaces ==="
          ip netns list || true
          echo "=== Kernel messages ==="
          sudo dmesg | tail -50 || true
